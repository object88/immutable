package immutable

import "fmt"

type RoutineOptions struct {
	Width int
}

type routine struct {
	options *RoutineOptions
	base    Base
	funcs   []step
	err     *error
}

type step interface {
	execute(kvp <-chan keyValuePair)
}

type mapStep struct {
	f MapPredicate
}

func (ms *mapStep) execute(kvp <-chan keyValuePair) {
	x := <-kvp
	key, value := x.key, x.value
	result, err := ms.f(key, value)
}

type HashRoutine struct {
	routine
}

/*
type ListRoutine struct {
	routine
}
*/

func (*HashRoutine) GoFilter(f FilterPredicate) *HashRoutine {
	return nil
}

func (hr *HashRoutine) GoMap(predicate MapPredicate) *HashRoutine {
	// mutated := b.instantiate(b.Size(), nil)
	// abort := make(chan struct{})
	// ch := hr.base.iterate(abort)
	// for kvp := range ch {
	// 	newV, err := go predicate(kvp.key, kvp.value)
	// 	if err != nil {
	// 		hr.err = &err
	// 		close(abort)
	//
	// 		return hr
	// 	}
	// 	mutated.internalSet(kvp.key, newV)
	// }
	// return hr
	hr.funcs = append(hr.funcs, &mapStep{predicate})
	return hr
}

func (*HashRoutine) GoReduce(acc Value, f ReducePredicate) (Value, error) {
	return nil, nil
}

func (hr *HashRoutine) Result() (*HashMap, error) {
	routineCount := 10
	if routineCount > hr.base.Size() {
		routineCount = hr.base.Size()
	}

	var err error
	chans := make([]chan keyValuePair, routineCount)
	abort := make(chan error)
	ch := make(chan *HashMap)
	go func() {
		defer close(ch)

		for _, v := range chans {
		}

		for i := 0; i < hr.base.Size(); i++ {
			select {
			case res := <-resc:
				fmt.Println(res)
			case err = <-abort:
				return
			}
		}

	}()

	result := <-ch

	return result, nil
}

func (*HashRoutine) ToList() (*ListRoutine, error) {
	return nil, nil
}

/*
func (*ListRoutine) GoFilter(f FilterPredicate) *ListRoutine {
	return nil
}

func (*ListRoutine) GoMap(f MapPredicate) *ListRoutine {
	return nil
}

func (*ListRoutine) GoReduce(acc Value, f ReducePredicate) (Value, error) {
	return nil, nil
}

func (*ListRoutine) Result() (interface{}, error) {
	return nil, nil
}

func (*ListRoutine) ToHashmap() (*HashMap, error) {
	return nil, nil
}
*/
func (*routine) Error() error {
	return nil
}
